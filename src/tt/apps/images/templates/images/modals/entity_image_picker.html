{% extends "modals/action_2_with_cancel.html" %}
{% load icons %}

{% comment %}
Base image picker modal for selecting a reference image for any entity.

Context variables required:
- entity: The entity instance with a reference_image attribute
- picker_url: URL for form action and gallery refresh
- accessible_images: QuerySet of TripImage instances
- selected_date: Date object for current filter

Optional context variables:
- upload_url: URL for image upload modal (displays upload button if provided)

Subclasses must define these blocks:
- modal_dialog_id: Unique ID for the modal
- title_text: Modal title
{% endcomment %}

{% block modal_dialog_class %}tt-modal-dialog-800{% endblock %}

{% block preamble %}
<!-- Hidden form for date filter async submission (outside main form) -->
<form id="date-filter-form"
      method="get"
      data-async="modal"
      action="{{ picker_url }}">
  <input type="hidden" name="async_gallery" value="1">
</form>

<form method="post"
      action="{{ picker_url }}"
      data-async="modal"
      id="reference-image-picker-form">
  {% csrf_token %}
  <input type="hidden" name="image_uuid" class="{{ TtConst.IMAGE_PICKER_UUID_INPUT_CLASS }}" value="">
{% endblock %}

{% block body %}
  <!-- Sticky Header Section -->
  <div style="position: sticky; top: 0; background: white; z-index: 10; padding-bottom: 1rem; margin-bottom: 1rem; border-bottom: 1px solid #dee2e6;">
    <!-- Current Selection Preview -->
    <div class="mb-3">
      <label class="font-weight-bold d-block mb-2">Selected Reference Image:</label>
      <div class="d-flex align-items-center">
        <div class="{{ TtConst.IMAGE_PICKER_PREVIEW_CLASS }}"
             style="width: 120px; height: 120px; border: 2px solid #dee2e6; border-radius: 8px; overflow: hidden; flex-shrink: 0;">
          {% if entity.reference_image and entity.reference_image.thumbnail_image %}
          <img src="{{ entity.reference_image.thumbnail_image.url }}"
               alt="Current reference"
               style="width: 100%; height: 100%; object-fit: cover;">
          {% else %}
          <div class="bg-light d-flex align-items-center justify-content-center text-muted h-100">
            {% icon "camera" size="lg" %}
          </div>
          {% endif %}
        </div>
        <div class="ml-3">
          <p class="mb-1 text-muted small">
            <strong>Current:</strong>
            <span class="{{ TtConst.IMAGE_PICKER_CAPTION_CLASS }}">
              {% if entity.reference_image %}
                {{ entity.reference_image.caption|default:"No caption" }}
              {% else %}
                No reference image set
              {% endif %}
            </span>
          </p>
          <p class="mb-0 text-muted small">Click an image below to change</p>
        </div>
      </div>
    </div>

    <!-- Date Filter Section -->
    <div class="form-group mb-0">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <label for="date-filter" class="font-weight-bold mb-0">
          {% icon "calendar" size="sm" css_class="tt-icon-left" %}
          Filter by Date
        </label>
        {% if upload_url %}
        <a href="{{ upload_url }}"
           class="btn btn-sm btn-outline-primary"
           data-async="modal">
          {% icon "upload" size="sm" css_class="tt-icon-left" %}
          Upload
        </a>
        {% endif %}
      </div>
      <input type="date"
             id="date-filter"
             name="date"
             value="{{ selected_date|date:'Y-m-d' }}"
             class="form-control"
             onchange-async="true"
             form="date-filter-form">
    </div>
  </div>

  <!-- Image Gallery Container -->
  <div id="reference-image-gallery-container" style="max-height: 400px; overflow-y: auto; padding: 1rem;">
    {% if accessible_images %}
      <div class="reference-image-picker-grid" style="display: grid !important; grid-template-columns: repeat(3, 1fr) !important; gap: 1rem;">
        {% include "images/components/image_picker_gallery_grid.html" %}
      </div>
    {% else %}
      <div class="alert alert-info">
        <p class="mb-0">No images found for {{ selected_date|date:"F j, Y" }}. Try selecting a different date.</p>
      </div>
    {% endif %}
  </div>
{% endblock %}

{% block action_right %}
<button type="submit"
        class="btn btn-primary {{ TtConst.IMAGE_PICKER_SET_BTN_CLASS }}"
        form="reference-image-picker-form"
        disabled>
  {% icon "save" size="sm" css_class="tt-icon-left" %}
  SET
</button>
{% endblock %}

{% block postamble %}
</form>
{% endblock %}

{% load icons %}

<div class="card">
  <div class="card-header">
    <h5 class="mb-0">This Browser</h5>
  </div>
  <div class="card-body">

    <!-- State: Not Installed (default before extension runs) -->
    <div class="{{ TtConst.EXT_SHOW_NOT_INSTALLED_CLASS }}">
      <div class="row">
        <div class="col-md-8">
          <div id="tt-ext-status-message" class="alert alert-info mt-3">
            {% icon "download" size="sm" %} <span id="tt-ext-status-text">Extension not detected.</span>
          </div>
        </div>
        <div class="col-md-4 text-center">
          {% icon "plug" size="xxxl" css_class="text-muted" %}
        </div>
      </div>
    </div>

    <!-- State: Server Mismatch (extension configured for different server) -->
    <div class="{{ TtConst.EXT_SHOW_SERVER_MISMATCH_CLASS }}">
      <div class="row">
        <div class="col-md-8">
          <div class="alert alert-warning mt-3">
            {% icon "alert-triangle" size="sm" %} <strong>Extension configured for different server</strong>
          </div>
          <p class="text-muted">
            The Trip Tools extension is installed but configured to connect to a different server.
            Open the extension's Options page to update the server URL.
          </p>
        </div>
        <div class="col-md-4 text-center">
          {% icon "plug" size="xxxl" css_class="text-warning" %}
        </div>
      </div>
    </div>

    <!-- State: Account Mismatch (extension authorized to different account) -->
    <div class="{{ TtConst.EXT_SHOW_ACCOUNT_MISMATCH_CLASS }}">
      <div class="row">
        <div class="col-md-8">
          <div class="alert alert-warning mt-3">
            {% icon "alert-triangle" size="sm" %} <strong>Extension connected to different account</strong>
          </div>
          <p class="text-muted">
            The Trip Tools extension is connected to a different account.
            To use the extension with this account, open the extension's Options page
            and click Disconnect, then return here to connect.
          </p>
        </div>
        <div class="col-md-4 text-center">
          {% icon "plug" size="xxxl" css_class="text-warning" %}
        </div>
      </div>
    </div>

    <!-- State: Installed but Not Authorized -->
    <div id="{{ TtConst.EXT_AUTH_RESULT_ID }}" class="{{ TtConst.EXT_SHOW_NOT_AUTHORIZED_CLASS }}">
      <div class="row">
        <div class="col-md-8">
          <p class="mb-3 alert alert-warning">Extension detected, but not connected.</p>
          <p class="text-primary mb-3">
            Click to authorize and connect the extension to your Trip Tools account.
          </p>
          <div>
            <form method="post" data-async="true" debounce>
              {% csrf_token %}
              <button type="submit" class="btn btn-lg btn-secondary">
                {% icon "plug" size="sm" %} Connect Extension
              </button>
            </form>
          </div>
          <p class="mt-3">
            You are signed in as <strong>{{ user.email }}</strong>
          </p>
        </div>
        <div class="col-md-4 text-center">
          {% icon "plug" size="xxxl" css_class="text-primary" %}
        </div>
      </div>
    </div>

    <!-- State: Installed and Authorized -->
    <div class="{{ TtConst.EXT_SHOW_AUTHORIZED_CLASS }}">
      {% include "user/components/extension_authorized.html" %}
    </div>

  </div>
</div>

<script>
(function() {
  var extensionResponded = false;

  window.addEventListener('message', function(event) {
    if (event.origin !== window.location.origin) return;
    if (!event.data || event.data.type !== '{{ TtConst.EXT_POSTMESSAGE_ACK_TYPE }}') return;

    extensionResponded = true;
    var pendingEl = document.getElementById('{{ TtConst.EXT_AUTH_PENDING_ID }}');
    if ( pendingEl ) {
      pendingEl.classList.add('d-none');
    }
    if (event.data.payload.success) {
      var successEl = document.getElementById('{{ TtConst.EXT_AUTH_SUCCESS_ID }}');
      if ( successEl ) {
        successEl.classList.remove('d-none');
      }
    } else {
      var failureEl = document.getElementById('{{ TtConst.EXT_AUTH_FAILURE_ID }}');
      if ( failureEl ) {
        var failureMsg = ( event.data.payload.error || 'Authorization failed' );
        failureEl.classList.remove('d-none');
      }
    }
  });

   window.handlePostAsyncUpdate = function() {
    var tokenEl = document.getElementById('{{ TtConst.EXT_TOKEN_DATA_ELEMENT_ID }}');
    if (tokenEl) {
      var token = tokenEl.dataset.token;
      if (token) {
        window.postMessage({
          type: '{{ TtConst.EXT_POSTMESSAGE_DATA_TYPE }}',
          payload: { action: 'authorize', token: token }
        }, window.location.origin);

        setTimeout(function() {
          if (!extensionResponded) {
            var fallbackEl = document.getElementById('{{ TtConst.EXT_AUTH_FAILURE_ID }}');
            if (fallbackEl) {
              fallbackEl.classList.remove('d-none');
            }
          }
        }, 2000);
      }
    }
  };
})();
</script>

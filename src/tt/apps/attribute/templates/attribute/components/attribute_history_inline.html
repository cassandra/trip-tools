{% load humanize %}
{% load icons %}
{% load attribute_extras %}
{% comment %}
Inline Attribute History Component
Compact history display that loads into attribute cards
{% endcomment %}

<div class="{{ DIVID.ATTR_V2_HISTORY_INLINE_CONTENT_CLASS }}">
  <!-- History Header -->
  <div class="{{ DIVID.ATTR_V2_HISTORY_HEADER_CLASS }}">
    <small class="text-muted">
      <strong>History for "{{ attribute.name }}"</strong>
    </small>
    <button type="button" 
            class="btn btn-sm btn-link p-0 {{ DIVID.ATTR_V2_HISTORY_CLOSE_CLASS }}"
            onclick="$('#{{ attr_item_context|history_target_id:attribute.id }}').empty();"
            title="Close history">
      {% icon "close" size="sm" %}
    </button>
  </div>
  
  <!-- Current Value -->
  <div class="{{ DIVID.ATTR_V2_HISTORY_CURRENT_CLASS }} mb-2">
    <small class="text-muted">Current:</small>
    <span class="badge badge-primary ml-1">{{ attribute.value|attribute_preview }}</span>
  </div>
  
  {% if history_records %}
  <!-- History Records -->
  <div class="{{ DIVID.ATTR_V2_HISTORY_RECORDS_CLASS }}">
    {% for record in history_records %}
    <div class="{{ DIVID.ATTR_V2_HISTORY_RECORD_CLASS }} {% if forloop.counter > 3 %}collapse{% endif %}" 
         {% if forloop.counter > 3 %}id="{{ attr_item_context|history_toggle_id:attribute.id }}"{% endif %}>
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <small class="text-muted">{{ record.changed_datetime|naturaltime }}</small>
          <span class="badge badge-light ml-2">{{ record.value|attribute_preview }}</span>
        </div>
        <div>
          {% if record.value != attribute.value %}
            <a href="{% attr_restore_url attr_item_context attribute.id record.pk %}"
               class="btn btn-xs btn-outline-primary {{ DIVID.ATTR_V2_RESTORE_LINK_CLASS }}"
               title="Restore this value">
              Restore
            </a>
          {% else %}
            <small class="text-muted">Current</small>
          {% endif %}
        </div>
      </div>
    </div>
    {% endfor %}
    
    <!-- Show More/Less Toggle -->
    {% if history_records|length > 3 %}
    <div class="{{ DIVID.ATTR_V2_HISTORY_TOGGLE_CLASS }} mt-2">
      <button type="button" 
              class="btn btn-sm btn-link p-0"
              data-toggle="collapse"
              data-target="#{{ attr_item_context|history_toggle_id:attribute.id }}"
              onclick="$(this).find('.show-more-history, .show-less-history').toggle();">
        <small class="show-more-history">Show {{ history_records|length|add:'-3' }} more...</small>
        <small class="show-less-history" style="display: none;">Show less</small>
      </button>
    </div>
    {% endif %}
  </div>
  {% else %}
  <!-- No History -->
  <div class="{{ DIVID.ATTR_V2_HISTORY_EMPTY_CLASS }}">
    <small class="text-muted">No previous values recorded.</small>
  </div>
  {% endif %}
</div>

{% load common_tags %}
{% comment %}
Text Attribute Value Component
Renders textarea with special handling (hidden input + display textarea) for text attributes
This component handles the auto-sizing and expand/collapse functionality
{% endcomment %}

<!-- Hidden field pattern for data integrity -->
{% with value_text=attribute_form.value.value|default_if_none:'' %}
{% with line_count=value_text|linecount %}
{% with display_rows=line_count|min_value:4 %}
{% with overflows=line_count|add:"-4" %}
<div class="{{ TtConst.ATTR_TEXT_VALUE_WRAPPER_CLASS }}"
     {{ TtConst.DATA_OVERFLOW_ATTR }}="{% if overflows > 0 %}true{% else %}false{% endif %}"
     {{ TtConst.DATA_LINE_COUNT_ATTR }}="{{ line_count }}">
  
  <!-- Real form field - contains actual data, never manipulated during editing -->
  <input type="hidden" 
         name="{{ attribute_form.value.html_name }}"
         id="hidden-{{ attribute_form.value.id_for_label }}"
         value="{{ attribute_form.value.value|default_if_none:'' }}">
  
  <!-- Display field - for UI only (no name = not submitted) -->
  <textarea rows="{{ display_rows }}" 
            id="{{ attribute_form.value.id_for_label }}"
            class="form-control {{ TtConst.ATTR_TEXTAREA_CLASS }} {{ TtConst.ATTR_DISPLAY_FIELD_CLASS }}"
            {{ TtConst.DATA_OVERFLOW_ATTR }}="{% if overflows > 0 %}true{% else %}false{% endif %}"
            {{ TtConst.DATA_HIDDEN_FIELD_ATTR }}="hidden-{{ attribute_form.value.id_for_label }}"
            {% if attribute_form.instance and not attribute_form.instance.is_editable %}disabled="true"{% endif %}
            {{ TtConst.DATA_ORIGINAL_VALUE_ATTR }}="{{ attribute_form.value.value|default_if_none:'' }}">{{ attribute_form.value.value|default_if_none:'' }}</textarea>
  {% if attribute_form.value.errors %}
    <div class="attr-field-errors">
      {% for error in attribute_form.value.errors %}
      <div class="attr-error-text">{{ error }}</div>
      {% endfor %}
    </div>
  {% endif %}
  {% if overflows > 0 %}
    <div class="{{ TtConst.ATTR_EXPAND_CONTROLS_CLASS }}" style="display: block;">
    <button type="button" class="btn btn-sm btn-link" onclick="Tt.attr.toggleExpandedView(this)">
      <span class="{{ TtConst.ATTR_SHOW_MORE_TEXT_CLASS }}">Show more...</span>
      <span class="{{ TtConst.ATTR_SHOW_LESS_TEXT_CLASS }}" style="display: none;">Show less</span>
    </button>
  </div>
  {% endif %}
</div>
{% endwith %}
{% endwith %}
{% endwith %}
{% endwith %}

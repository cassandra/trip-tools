{% extends "journal/pages/journal_base.html" %}
{% load icons %}
{% load travelog_tags %}
{% load pipeline %}

{% block head_css %}
{% stylesheet 'journal_editor' %}
{% endblock %}

{% block trip_content %}
<div class="m-3">
  <div class="card mb-3">
    <div class="row no-gutters">
      <div class="col-3 col-md-2" id="journal-reference-image-container">
        <a href="{% url 'journal_reference_image_picker' journal_uuid=journal.uuid %}" data-async="modal" title="Click to change reference image">
          {% include "images/components/reference_image_display.html" with image=journal.reference_image size="md" editable=True %}
        </a>
      </div>

      <div class="col-9 col-md-10">
        <div class="card-header bg-white">
          <div class="d-flex w-100 align-items-start mb-2">
            <h3 class="mb-0 mr-2">{{ journal.title }}</h3>
            <a href="{% url 'journal_edit' journal_uuid=journal.uuid %}"
               data-async="modal"
               class="text-muted"
               style="opacity: 0.6; transition: opacity 0.2s;"
               onmouseover="this.style.opacity='1'"
               onmouseout="this.style.opacity='0.6'"
               title="Edit journal title and description"
               {% if not trip_page.request_member.can_edit_trip %}style="display:none;"{% endif %}>
              {% icon "edit" size="sm" %}
            </a>
          </div>
          {% if journal.description %}
          <p class="text-muted mb-2">{{ journal.description }}</p>
          {% endif %}
          <div class="d-flex align-items-center flex-wrap">
            <small class="text-muted mr-3">
              {% icon "globe" size="sm" css_class="tt-icon-left" %}
              Timezone: {{ journal.timezone }}
            </small>
            <small class="text-muted">
              {% icon "clock" size="sm" css_class="tt-icon-left" %}
              Created {{ journal.created_datetime|date:"N j, Y" }}
            </small>
          </div>
        </div>
      </div>
    </div>

    {% if journal.is_misconfigured_protected and trip_page.request_member.permission_level.is_admin %}
    <div class="alert alert-warning mx-3 mt-2 mb-0" role="alert">
      <div class="d-flex align-items-start">
        <div class="mr-2">
          {% icon "warning" size="md" %}
        </div>
        <div>
          <strong>Configuration Warning:</strong> This journal is set to PROTECTED visibility but has no password.
          It is currently being treated as PRIVATE (only trip members can access).
          <a href="{% url 'journal_visibility' journal_uuid=journal.uuid %}"
             data-async="modal"
             class="alert-link">Set a password</a> to allow password-protected public access.
        </div>
      </div>
    </div>
    {% endif %}

    <div class="card-body">
      {# Primary Actions: Large and Prominent #}
      <div class="mb-3">
        <div class="btn-toolbar justify-content-between" role="toolbar">
          <div class="btn-group" role="group">
            <a class="btn btn-success btn-lg"
               href="{% url 'journal_publish' journal_uuid=journal.uuid %}"
               data-async="modal"
               title="Publish your latest changes as a new version"
               {% if not trip_page.request_member.permission_level.is_admin %}disabled{% elif publishing_status.is_published_without_changes %}disabled{% endif %}>
              {% icon "upload" size="sm" css_class="tt-icon-left" %}
              {% if publishing_status.has_published_version %}Publish Changes{% else %}Publish First Version{% endif %}
            </a>
            <a href="{% travelog_url 'travelog_toc' journal.uuid version='draft' refresh=True %}"
               target="_blank"
               class="btn btn-outline-primary btn-lg"
               title="Preview how your journal will appear to readers"
               {% if not trip_page.request_member.can_edit_trip %}onclick="return false;" style="pointer-events: none; opacity: 0.65;"{% endif %}>
              {% icon "eye" size="sm" css_class="tt-icon-left" %}
              Preview
            </a>
          </div>
        </div>
      </div>

      {# Publishing Status: Color-Coded Alert Box #}
      {% if publishing_status.has_published_version %}
        {% if publishing_status.has_unpublished_changes %}
          {# State 1: Has Unpublished Changes #}
          <div class="alert alert-warning mb-0" role="alert">
            <div class="row align-items-center">
              <div class="col-md-8">
                <div class="d-flex align-items-start">
                  <div class="mr-2">
                    {% icon "exclamation-circle" %}
                  </div>
                  <div class="flex-grow-1">
                    <div class="d-flex align-items-center mb-1">
                      <span class="badge badge-{{ journal.visibility.badge_color }} mr-2">
                        {% icon journal.visibility.icon_name size="sm" css_class="tt-icon-left" %}
                        {{ journal.visibility.label }}
                      </span>
                      <strong>Version {{ publishing_status.current_published_version.version_number }}</strong>
                      <span class="text-muted ml-2">
                        &bull; Published {{ publishing_status.current_published_version.published_datetime|date:"N j, Y" }}
                        {% if publishing_status.current_published_version.published_by %}
                          by {% if publishing_status.current_published_version.published_by.get_full_name %}{{ publishing_status.current_published_version.published_by.get_full_name }}{% else %}{{ publishing_status.current_published_version.published_by.email }}{% endif %}
                        {% endif %}
                      </span>
                    </div>
                    <small><strong>You have unpublished changes</strong> that are not yet visible to readers.</small>
                  </div>
                </div>
              </div>
              <div class="col-md-4 text-right">
                <div class="btn-group-vertical btn-group-sm" role="group">
                  <a href="{% travelog_url 'travelog_toc' journal.uuid %}"
                     target="_blank"
                     class="btn btn-outline-dark">
                    {% icon "eye" size="sm" css_class="tt-icon-left" %}
                    View Published
                  </a>
                  <a href="{% url 'journal_versions' journal_uuid=journal.uuid %}"
                     data-async="modal"
                     class="btn btn-outline-dark">
                    {% icon "history" size="sm" css_class="tt-icon-left" %}
                    Version History
                  </a>
                  <a href="{% url 'journal_visibility' journal_uuid=journal.uuid %}"
                     data-async="modal"
                     class="btn btn-outline-dark"
                     {% if not trip_page.request_member.permission_level.is_admin %}disabled{% endif %}>
                    {% icon "shield" size="sm" css_class="tt-icon-left" %}
                    Change Visibility
                  </a>
                </div>
              </div>
            </div>
          </div>
        {% else %}
          {# State 2: Up to Date #}
          <div class="alert alert-success mb-0" role="alert">
            <div class="row align-items-center">
              <div class="col-md-8">
                <div class="d-flex align-items-start">
                  <div class="mr-2">
                    {% icon "check-circle" %}
                  </div>
                  <div class="flex-grow-1">
                    <div class="d-flex align-items-center mb-1">
                      <span class="badge badge-{{ journal.visibility.badge_color }} mr-2">
                        {% icon journal.visibility.icon_name size="sm" css_class="tt-icon-left" %}
                        {{ journal.visibility.label }}
                      </span>
                      <strong>Version {{ publishing_status.current_published_version.version_number }}</strong>
                      <span class="text-muted ml-2">
                        &bull; Published {{ publishing_status.current_published_version.published_datetime|date:"N j, Y" }}
                        {% if publishing_status.current_published_version.published_by %}
                          by {% if publishing_status.current_published_version.published_by.get_full_name %}{{ publishing_status.current_published_version.published_by.get_full_name }}{% else %}{{ publishing_status.current_published_version.published_by.email }}{% endif %}
                        {% endif %}
                      </span>
                    </div>
                    <small><strong>Up to date</strong> â€” your published version matches your working copy.</small>
                  </div>
                </div>
              </div>
              <div class="col-md-4 text-right">
                <div class="btn-group-vertical btn-group-sm" role="group">
                  <a href="{% travelog_url 'travelog_toc' journal.uuid %}"
                     target="_blank"
                     class="btn btn-outline-dark">
                    {% icon "eye" size="sm" css_class="tt-icon-left" %}
                    View Published
                  </a>
                  <a href="{% url 'journal_versions' journal_uuid=journal.uuid %}"
                     data-async="modal"
                     class="btn btn-outline-dark">
                    {% icon "history" size="sm" css_class="tt-icon-left" %}
                    Version History
                  </a>
                  <a href="{% url 'journal_visibility' journal_uuid=journal.uuid %}"
                     data-async="modal"
                     class="btn btn-outline-dark"
                     {% if not trip_page.request_member.permission_level.is_admin %}disabled{% endif %}>
                    {% icon "shield" size="sm" css_class="tt-icon-left" %}
                    Change Visibility
                  </a>
                </div>
              </div>
            </div>
          </div>
        {% endif %}
      {% else %}
        {# State 3: Not Yet Published #}
        <div class="alert alert-info mb-0" role="alert">
          <div class="row align-items-center">
            <div class="col-md-8">
              <div class="d-flex align-items-start">
                <div class="mr-2">
                  {% icon "info-circle" %}
                </div>
                <div class="flex-grow-1">
                  <div class="d-flex align-items-center mb-1">
                    <span class="badge badge-{{ journal.visibility.badge_color }} mr-2">
                      {% icon journal.visibility.icon_name size="sm" css_class="tt-icon-left" %}
                      {{ journal.visibility.label }}
                    </span>
                    <strong>Not yet published</strong>
                  </div>
                  <small>Create some journal entries and publish your first version when ready.</small>
                </div>
              </div>
            </div>
            <div class="col-md-4 text-right">
              <div class="btn-group-vertical btn-group-sm" role="group">
                <a href="{% url 'journal_visibility' journal_uuid=journal.uuid %}"
                   data-async="modal"
                   class="btn btn-outline-dark"
                   {% if not trip_page.request_member.permission_level.is_admin %}disabled{% endif %}>
                  {% icon "shield" size="sm" css_class="tt-icon-left" %}
                  Change Visibility
                </a>
              </div>
            </div>
          </div>
        </div>
      {% endif %}
    </div>
  </div>

  {% if journal_entries %}
  {% for entry in journal_entries %}
  <a href="{% url 'journal_entry' entry_uuid=entry.uuid %}"
     class="card mb-3 text-decoration-none text-dark d-block">
    <div class="row no-gutters">
      {# Left side: Reference image or placeholder #}
      <div class="col-3 col-md-2">
        {% include "images/components/reference_image_display.html" with image=entry.reference_image size="md" %}
      </div>

      {# Right side: Entry content #}
      <div class="col-9 col-md-10">
        <div class="card-body">
          <div class="d-flex w-100 justify-content-between align-items-start">
            <div>
              <h5 class="mb-1">
                {{ entry.title|default:entry.display_date_long }}
              </h5>
              {% if entry.text %}
              <small class="text-muted">{{ entry.display_date_long }}</small>
              {% endif %}
              {% if not entry.include_in_publish %}
              <small class="text-danger d-block">Excluded from publish</small>
              {% endif %}
              {% if not entry.text %}
              <p class="mb-0 text-muted"><em>Empty entry</em></p>
              {% endif %}
            </div>
            <div class="text-right ml-2 flex-shrink-0">
              <small class="text-muted d-block">Modified {{ entry.modified_datetime|date:"M j, Y, g:i A" }}</small>
              {% if entry.modified_by %}
              <small class="text-muted d-block">by {{ entry.modified_by.first_name|default:entry.modified_by.email }}</small>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </a>
  {% endfor %}
  {% else %}
  <div class="alert alert-info">
    <h4>No journal entries yet</h4>
    <p>Your journal has been created! Add entries to share your trip experiences.</p>
    <a href="{% url 'journal_entry_new' journal_uuid=journal.uuid %}" class="btn btn-primary">Create Entry</a>
  </div>
  {% endif %}

</div>
{% endblock %}

{% block footer_post_javascript %}
{{ block.super }}
{% javascript 'journal_editor' %}
{% endblock %}

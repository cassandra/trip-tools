{% extends "journal/pages/journal_base.html" %}
{% load icons %}

{% block trip_content %}
<div class="m-3">

  {# Journal Metadata Card #}
  <div class="card mb-3">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-start mb-3">
        <div class="flex-grow-1">
          <h3 class="mb-2">{{ journal.title }}</h3>
          {% if journal.description %}
          <p class="text-muted mb-2">{{ journal.description }}</p>
          {% endif %}
          <div class="d-flex align-items-center flex-wrap">
            <small class="text-muted mr-3">
              {% icon "globe" size="sm" css_class="tt-icon-left" %}
              Timezone: {{ journal.timezone }}
            </small>
            <small class="text-muted">
              {% icon "clock" size="sm" css_class="tt-icon-left" %}
              Created {{ journal.created_datetime|date:"N j, Y" }}
            </small>
          </div>
        </div>
        <a class="btn btn-sm btn-outline-secondary ml-3"
           href="{% url 'journal_edit' journal_uuid=journal.uuid %}"
           data-async="modal"
           {% if not trip_page.request_member.can_edit_trip %}disabled{% endif %}>
          {% icon "edit" size="sm" css_class="tt-icon-left" %}
          Edit Journal
        </a>
      </div>

      {# Publishing and Visibility Section #}
      <div class="border-top pt-3">
        <div class="row">
          <div class="col-md-6 mb-3 mb-md-0">
            <h6 class="font-weight-bold mb-2">Publishing Status</h6>

            {# Visibility Badge #}
            <div class="d-flex align-items-center mb-2">
              <span class="badge badge-{{ journal.visibility.badge_color }}">
                {% icon journal.visibility.icon_name size="sm" css_class="tt-icon-left" %}
                {{ journal.visibility.label }}
              </span>
              <a class="btn btn-sm btn-outline-warning ml-2"
                 href="{% url 'journal_visibility' journal_uuid=journal.uuid %}"
                 data-async="modal"
                 {% if not trip_page.request_member.permission_level.is_admin %}disabled{% endif %}>
                {% icon "shield" size="sm" css_class="tt-icon-left" %}
                Change Visibility
              </a>
            </div>

            {# Publishing Status Display #}
            {% if publishing_status.has_published_version %}
              {# Published Journal - Show Version Info #}
              <div class="mt-2">
                <small class="text-muted d-block">
                  <strong>Version {{ publishing_status.current_published_version.version_number }}</strong>
                  &bull;
                  Published {{ publishing_status.current_published_version.published_datetime|date:"N j, Y" }}
                  {% if publishing_status.current_published_version.published_by %}
                    by {% if publishing_status.current_published_version.published_by.get_full_name %}{{ publishing_status.current_published_version.published_by.get_full_name }}{% else %}{{ publishing_status.current_published_version.published_by.email }}{% endif %}
                  {% endif %}
                </small>
                {% if publishing_status.has_unpublished_changes %}
                  <small class="text-warning d-block mt-1">
                    {% icon "exclamation-circle" size="sm" css_class="tt-icon-left" %}
                    Unpublished changes
                  </small>
                {% else %}
                  <small class="text-success d-block mt-1">
                    {% icon "check-circle" size="sm" css_class="tt-icon-left" %}
                    Up to date
                  </small>
                {% endif %}
              </div>

              {# Version History Link #}
              <div class="mt-2">
                <a href="{% url 'journal_versions' journal_uuid=journal.uuid %}"
                   data-async="modal"
                   class="btn btn-sm btn-outline-info">
                  {% icon "history" size="sm" css_class="tt-icon-left" %}
                  View Version History
                </a>
              </div>
            {% else %}
              {# Unpublished Journal #}
              <div class="mt-2">
                <small class="text-muted d-block">
                  <strong>Status: Unpublished</strong>
                </small>
                <small class="text-muted d-block">
                  Ready to publish
                </small>
              </div>
            {% endif %}
          </div>

          <div class="col-md-6">
            <h6 class="font-weight-bold mb-2">Actions</h6>
            <div class="d-flex flex-wrap">
              <button class="btn btn-sm btn-outline-primary mr-2 mb-2"
                      title="Preview how your journal will appear to readers"
                      {% if not trip_page.request_member.can_edit_trip %}disabled{% elif not publishing_status.has_published_version %}disabled{% endif %}>
                {% icon "eye" size="sm" css_class="tt-icon-left" %}
                Preview
              </button>
              <a class="btn btn-sm btn-primary mb-2"
                 href="{% url 'journal_publish' journal_uuid=journal.uuid %}"
                 data-async="modal"
                 title="Publish your latest changes as a new version"
                 {% if not trip_page.request_member.permission_level.is_admin %}disabled{% elif publishing_status.is_published_without_changes %}disabled{% endif %}>
                {% icon "upload" size="sm" css_class="tt-icon-left" %}
                Publish
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  {% if journal_entries %}
  <div class="list-group">
    {% for entry in journal_entries %}
    <a href="{% url 'journal_entry' entry_uuid=entry.uuid %}"
       class="list-group-item list-group-item-action">
      <div class="d-flex w-100 justify-content-between">
        <h5 class="mb-1">
          {% if entry.title %}
          {{ entry.title }}
          {% else %}
          {{ entry.date|date:'l, F j, Y' }}
          {% endif %}
        </h5>
        <small class="text-muted">Modified {{ entry.modified_datetime|timesince }} ago</small>
      </div>
      {% if entry.text %}
      <p class="mb-1 text-truncate">{{ entry.text|truncatewords:20 }}</p>
      {% else %}
      <p class="mb-1 text-muted"><em>Empty entry</em></p>
      {% endif %}
    </a>
    {% endfor %}
  </div>
  {% else %}
  <div class="alert alert-info">
    <h4>No journal entries yet</h4>
    <p>Your journal has been created! Add entries to share your trip experiences.</p>
    <a href="{% url 'journal_entry_new' journal_uuid=journal.uuid %}" class="btn btn-primary">Create Entry</a>
  </div>
  {% endif %}

</div>
{% endblock %}

{% extends "modals/action_2_with_cancel.html" %}
{% load icons %}

{% block modal_dialog_id %}journal-publish-modal{% endblock %}
{% block title_text %}Publish Journal{% endblock %}

{% block preamble %}
<form method="post" action="{% url 'journal_publish' journal_uuid=journal.uuid %}" data-async="modal">
  {% csrf_token %}
{% endblock %}

{% block body %}
  {# Compact Status Card #}
  <div class="card bg-light mb-4">
    <div class="card-body py-3">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          {% if publishing_status.has_published_version %}
            <span class="text-muted">Current:</span>
            <strong>Version {{ publishing_status.current_published_travelog.version_number }}</strong>
            <span class="text-muted ml-2">
              ({{ publishing_status.current_published_travelog.published_datetime|date:"M j, Y" }})
            </span>
          {% else %}
            <span class="text-muted">Status:</span>
            <strong>Never Published</strong>
          {% endif %}
        </div>
        <div>
          {% if publishing_status.has_unpublished_changes %}
            <span class="badge badge-warning">Unpublished Changes</span>
          {% elif publishing_status.has_published_version %}
            <span class="badge badge-success">Up to Date</span>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  {# Visibility Section - Primary Control #}
  <div class="mb-4">
    <label class="font-weight-bold d-block mb-2">
      {% icon "eye" size="sm" css_class="tt-icon-left text-muted" %}
      Who can view this journal?
    </label>
    {% include "journal/components/visibility_form_fields.html" with form=visibility_form journal=journal %}
  </div>

  {# Pages Section #}
  {% if journal_entries %}
  <div class="mb-4">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <label class="font-weight-bold mb-0">
        {% icon "book" size="sm" css_class="tt-icon-left text-muted" %}
        Pages to Publish
      </label>
      <span class="text-muted">{{ total_entries }} pages</span>
    </div>

    {% if not all_entries_included %}
      {# Warning when not all pages selected #}
      <div class="alert alert-warning py-2 mb-2">
        <small>
          {% icon "warning" size="sm" css_class="tt-icon-left" %}
          Some pages are excluded from publishing.
        </small>
      </div>
    {% endif %}

    {# Collapsible page list using Bootstrap collapse #}
    <div>
      <a class="text-primary" data-toggle="collapse" href="#page-selection-list" role="button"
         aria-expanded="{% if not all_entries_included %}true{% else %}false{% endif %}"
         aria-controls="page-selection-list">
        {% if all_entries_included %}
          Review or change page selection
        {% else %}
          View page selection
        {% endif %}
      </a>
      <div class="collapse {% if not all_entries_included %}show{% endif %}" id="page-selection-list">
        <div class="border rounded p-3 mt-2" style="max-height: 250px; overflow-y: auto;">
          {% for entry in journal_entries %}
          <div class="form-check">
            <input type="checkbox"
                   name="selected_entries"
                   value="{{ entry.uuid }}"
                   id="entry-{{ entry.uuid }}"
                   class="form-check-input"
                   {% if entry.include_in_publish %}checked{% endif %}>
            <label class="form-check-label" for="entry-{{ entry.uuid }}">
              {% if entry.is_prologue %}
                <strong>Prologue</strong>
              {% elif entry.is_epilogue %}
                <strong>Epilogue</strong>
              {% else %}
                <strong>{{ entry.date|date:"M j, Y" }}</strong>
              {% endif %}
              <span class="text-muted">- {{ entry.title }}</span>
            </label>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  {# Form errors #}
  {% if visibility_form.non_field_errors %}
  <div class="alert alert-danger">{{ visibility_form.non_field_errors }}</div>
  {% endif %}
{% endblock %}

{% block action_right %}
<button type="submit" class="btn btn-primary">
  {% icon "upload" size="sm" css_class="tt-icon-left" %}
  {% if publishing_status.has_published_version %}
    PUBLISH VERSION {{ publishing_status.current_published_travelog.version_number|add:1 }}
  {% else %}
    PUBLISH
  {% endif %}
</button>
{% endblock %}

{% block postamble %}
</form>
{% endblock %}

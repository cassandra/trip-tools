<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <title>JavaScript Unit Tests - All Modules</title>
    <link rel="stylesheet" href="qunit/qunit-2.20.0.css">
</head>
<body>
    <div id="qunit"></div>
    <div id="qunit-fixture"></div>
    
    <!-- Dependencies -->
    <script src="../js/jquery-3.7.0.min.js"></script>
    
    <!-- Mock external dependencies that modules might use -->
    <script>
        // Mock antinode functionality for auto-view.js
        window.AN = {
            loadAsyncContent: function(options) {
                // Mock antinode functionality
                if (options.error) {
                    setTimeout(() => options.error({ status: 404 }, {}, 'Not Found'), 10);
                }
            }
        };

        // Mock TtClientConfig that main.js expects
        window.TtClientConfig = {
            DEBUG: false,
            IS_EDIT_MODE: false
        };

        // Mock TtConst - normally injected by server in base.html
        // main.js expects this to exist and adds derived selectors to it
        window.TtConst = {
            // Attribute Editing - class constants
            ATTR_FILE_INPUT_CLASS: 'attr-file-input',
            ATTR_FILE_TITLE_INPUT_CLASS: 'attr-file-title-input',
            ATTR_DIRTY_MESSAGE_CLASS: 'attr-dirty-message',
            ATTR_STATUS_MESSAGE_CLASS: 'attr-status-message',
            ATTR_UPDATE_BTN_CLASS: 'attr-update-btn',
            ATTR_ATTRIBUTE_NAME_CLASS: 'attr-attribute-name',
            ATTR_FORM_CLASS: 'attr-form',
            ATTR_FORM_DISPLAY_LABEL_CLASS: 'attr-form-display-label',
            ATTR_CONTAINER_CLASS: 'attr-container',
            ATTR_HISTORY_LINK_CLASS: 'attr-history-link',
            ATTR_RESTORE_LINK_CLASS: 'attr-restore-link',
            ATTR_ATTRIBUTE_CARD_CLASS: 'attr-attribute-card',
            ATTR_NEW_ATTRIBUTE_CLASS: 'attr-new-attribute',
            ATTR_FILE_INFO_CLASS: 'attr-file-info',
            ATTR_DELETE_BTN_CLASS: 'attr-delete-btn',
            ATTR_UNDO_BTN_CLASS: 'attr-undo-btn',
            ATTR_FILE_CARD_CLASS: 'attr-file-card',
            ATTR_SECRET_INPUT_WRAPPER_CLASS: 'attr-secret-input-wrapper',
            ATTR_SECRET_INPUT_CLASS: 'attr-secret-input',
            ATTR_ICON_SHOW_CLASS: 'attr-icon-show',
            ATTR_ICON_HIDE_CLASS: 'attr-icon-hide',
            ATTR_TEXTAREA_CLASS: 'attr-textarea',
            ATTR_TEXT_VALUE_WRAPPER_CLASS: 'attr-text-value-wrapper',
            ATTR_EXPAND_CONTROLS_CLASS: 'attr-expand-controls',
            ATTR_DISPLAY_FIELD_CLASS: 'attr-display-field',
            ATTR_SHOW_MORE_TEXT_CLASS: 'attr-show-more-text',
            ATTR_SHOW_LESS_TEXT_CLASS: 'attr-show-less-text',
            ORIGINAL_VALUE_DATA_ATTR: 'original-value',
            HIDDEN_FIELD_DATA_ATTR: 'hidden-field',

            // Journal - ID constants
            JOURNAL_EDITOR_ID: 'journal-editor',
            JOURNAL_TITLE_INPUT_ID: 'journal-title-input',
            JOURNAL_DATE_INPUT_ID: 'journal-date-input',
            JOURNAL_TIMEZONE_INPUT_ID: 'journal-timezone-input',
            JOURNAL_EDITOR_MULTI_IMAGE_GALLERY_ID: 'journal-editor-multi-image-gallery',
            JOURNAL_EDITOR_MULTI_IMAGE_FILTER_FORM_ID: 'image-filter-form',
            JOURNAL_EDITOR_MULTI_IMAGE_DATE_INPUT_ID: 'id_image_date_filter',
            JOURNAL_EDITOR_MULTI_IMAGE_ENTRY_DATE_BTN_ID: 'btn-entry-date-images',
            JOURNAL_EDITOR_MULTI_IMAGE_RECENT_BTN_ID: 'btn-recent-images',

            // Journal - class constants
            JOURNAL_EDITOR_CLASS: 'journal-contenteditable',
            JOURNAL_ENTRY_FORM_CLASS: 'journal-entry-form',
            JOURNAL_SAVE_STATUS_CLASS: 'journal-save-status',
            JOURNAL_EDITOR_MULTI_IMAGE_CARD_CLASS: 'journal-editor-multi-image-card',
            JOURNAL_IMAGE_WRAPPER_CLASS: 'trip-image-wrapper',
            JOURNAL_IMAGE_CLASS: 'trip-image',
            JOURNAL_EDITOR_MULTI_IMAGE_PANEL_HEADER_CLASS: 'journal-editor-multi-image-panel-header',
            LAYOUT_DATA_ATTR: 'layout',
            UUID_DATA_ATTR: 'uuid',
            TRIP_IMAGE_CAPTION_CLASS: 'trip-image-caption',
            IMAGE_UUID_DATA_ATTR: 'image-uuid',
            ENTRY_UUID_DATA_ATTR: 'entry-uuid',
            TRIP_UUID_DATA_ATTR: 'trip-uuid',
            IMAGE_MEDIA_URL_DATA_ATTR: 'image-url',
            THUMBNAIL_MEDIA_URL_DATA_ATTR: 'thumbnail-url',
            CAPTION_DATA_ATTR: 'caption',

            // Image picker - class constants
            IMAGE_PICKER_CAPTION_CLASS: 'image-picker-caption',
            JOURNAL_REFERENCE_IMAGE_CONTAINER_CLASS: 'journal-reference-image-container',
            JOURNAL_REFERENCE_IMAGE_PLACEHOLDER_CLASS: 'journal-reference-image-placeholder',
            JOURNAL_REFERENCE_IMAGE_PREVIEW_CLASS: 'journal-reference-image-preview',
            JOURNAL_REFERENCE_IMAGE_CLEAR_CLASS: 'journal-reference-image-clear',
            JOURNAL_REFERENCE_IMAGE_THUMBNAIL_CLASS: 'journal-reference-image-thumbnail',
            IMAGE_PICKER_CARD_CLASS: 'image-picker-card',
            IMAGE_PICKER_UUID_INPUT_CLASS: 'image-picker-uuid-input',
            IMAGE_PICKER_PREVIEW_CLASS: 'image-picker-preview',
            IMAGE_PICKER_SET_BTN_CLASS: 'image-picker-set-btn',
            IMAGES_UPLOADED_ITEM_CLASS: 'images-uploaded-item',
            JOURNAL_EDITOR_MULTI_IMAGE_GALLERY_CLASS: 'journal-editor-multi-image-gallery',

            // Journal content structure - needed for html-normalization.js
            JOURNAL_CONTENT_BLOCK_CLASS: 'text-block',
            JOURNAL_FLOAT_MARKER_CLASS: 'has-float-image',
            // These selectors are generated by main.js from LAYOUT_DATA_ATTR
            JOURNAL_IMAGE_WRAPPER_FLOAT_SELECTOR: '.trip-image-wrapper[data-layout="float-right"]',
            JOURNAL_IMAGE_WRAPPER_FULL_SELECTOR: '.trip-image-wrapper[data-layout="full-width"]',
            JOURNAL_IMAGE_WRAPPER_SELECTOR: '.trip-image-wrapper',
            JOURNAL_IMAGE_SELECTOR: 'img.trip-image',
            JOURNAL_EDITOR_MULTI_IMAGE_CARD_SELECTOR: '.journal-editor-multi-image-card',

            // Reference image - needed for reference-manager.js
            JOURNAL_REFERENCE_IMAGE_CONTAINER_CLASS: 'journal-reference-image-container',
            JOURNAL_REFERENCE_IMAGE_PLACEHOLDER_CLASS: 'journal-reference-image-placeholder',
            JOURNAL_REFERENCE_IMAGE_PREVIEW_CLASS: 'journal-reference-image-preview',
            JOURNAL_REFERENCE_IMAGE_CLEAR_CLASS: 'journal-reference-image-clear',
            JOURNAL_REFERENCE_IMAGE_THUMBNAIL_CLASS: 'journal-reference-image-thumbnail',
            JOURNAL_REFERENCE_IMAGE_CONTAINER_SELECTOR: '.journal-reference-image-container',
            JOURNAL_REFERENCE_IMAGE_PLACEHOLDER_SELECTOR: '.journal-reference-image-placeholder',
            JOURNAL_REFERENCE_IMAGE_PREVIEW_SELECTOR: '.journal-reference-image-preview',
            JOURNAL_REFERENCE_IMAGE_CLEAR_SELECTOR: '.journal-reference-image-clear',
            JOURNAL_REFERENCE_IMAGE_THUMBNAIL_SELECTOR: '.journal-reference-image-thumbnail',
            REFERENCE_IMAGE_UUID_DATA_ATTR: 'reference-image-uuid',

            // Image picker scope constants
            IMAGE_PICKER_SCOPE_UNUSED: 'unused',
            IMAGE_PICKER_SCOPE_USED: 'used',
            IMAGE_PICKER_SCOPE_ALL: 'all',
            INITIAL_SCOPE_DATA_ATTR: 'initial-scope',
            JOURNAL_EDITOR_MULTI_IMAGE_FILTER_FORM_ID: 'journal-editor-multi-image-filter-form'
        };

        // Mock TtUrlPatterns - URL patterns generated via reverse() in production
        window.TtUrlPatterns = {
            PLACEHOLDER_UUID: '00000000-0000-0000-0000-000000000000',
            IMAGE_INSPECT: '/images/inspect/00000000-0000-0000-0000-000000000000',
            JOURNAL_ENTRY_AUTOSAVE: '/journal/entry/00000000-0000-0000-0000-000000000000/save'
        };
    </script>

    <!-- Source modules under test -->
    <!-- main.js must load first as it defines the base Tt namespace -->
    <script src="../js/main.js"></script>
    <script src="../js/watchdog.js"></script>
    <!-- Editor modules in dependency order -->
    <script src="../js/editor/html-normalization.js"></script>
    <script src="../js/editor/selection-utils.js"></script>
    <script src="../js/editor/layout-manager.js"></script>
    <script src="../js/editor/autosave-manager.js"></script>
    <script src="../js/editor/paste-handler.js"></script>
    <script src="../js/editor/toolbar-manager.js"></script>
    <script src="../js/editor/reference-manager.js"></script>
    <script src="../js/editor/keyboard-manager.js"></script>
    <script src="../js/editor/image-manager.js"></script>
    <script src="../js/editor/drag-drop-manager.js"></script>
    <script src="../js/editor/picker-filters-manager.js"></script>
    <script src="../js/editor/image-picker.js"></script>

    <!-- Test framework -->
    <script src="qunit/qunit-2.20.0.js"></script>
    
    <!-- Test configuration -->
    <script>
        // Configure QUnit
        QUnit.config.autostart = false;
        QUnit.config.reorder = false; // Keep test order consistent
        
        // Start tests after page load
        window.addEventListener('load', function() {
            QUnit.start();
        });
    </script>
    
    <!-- All test modules -->
    <script src="test-main.js"></script>
    <script src="test-watchdog.js"></script>
    <script src="test-journal-normalization.js"></script>
    <script src="test-journal-cursor.js"></script>
    <script src="test-journal-autosave.js"></script>
    <script src="test-journal-toolbar.js"></script>
    <script src="test-journal-reference.js"></script>
    <script src="test-journal-keyboard.js"></script>
    <script src="test-journal-image-manager.js"></script>
    <script src="test-journal-selection-utils.js"></script>
    <script src="test-journal-layout.js"></script>
    <script src="test-journal-image-picker.js"></script>
    <script src="test-journal-paste.js"></script>
    <script src="test-journal-drag-drop.js"></script>
</body>
</html>
